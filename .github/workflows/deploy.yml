name: Deploy to Production

# ğŸš€ PINOVARA Deploy v4.2 - ULTRA FAST DEPLOY
# âš¡ SKIP PRISMA - Uses existing client (30 seconds!)
# ğŸ“‹ BACKUP SYSTEM - Timestamp-based backups
# ğŸ› ï¸ Use 'Deploy Full' for Prisma regeneration

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Starting Safe Deploy v4.1
      run: |
        echo "ğŸ¯ PINOVARA Deploy v4.1 - WITH BACKUP SYSTEM"
        echo "âœ… SAFE backup system - Timestamp-based backups"
        echo "âœ… AUTO cleanup - Keeps only last 3 backups"
        echo "ğŸ“… $(date)"

    - name: ğŸ”§ Validate Secrets
      run: |
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âŒ SSH_PRIVATE_KEY secret not configured"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "âŒ SERVER_HOST secret not configured"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "âŒ SERVER_USER secret not configured"
          exit 1
        fi
        echo "âœ… All secrets configured"

    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: ğŸ—ï¸ Build Backend
      working-directory: ./backend
      run: |
        echo "ğŸ”¨ Building backend..."
        npm ci --production=false
        npm run build
        echo "âœ… Backend built successfully"

    - name: ğŸ³ Build Docker Image & Extract Prisma Client
      working-directory: ./backend
      run: |
        echo "ğŸ³ Building Docker image to generate Prisma Client with correct binaryTargets..."
        
        # Build Docker image (usa stage prisma-generator que gera o Prisma com binaryTargets corretos)
        docker build --target prisma-generator -t pinovara-backend:prisma-generator .
        
        echo "ğŸ“¦ Extracting Prisma Client from Docker image..."
        
        # Criar container temporÃ¡rio para extrair Prisma Client
        CONTAINER_ID=$(docker create pinovara-backend:prisma-generator)
        
        # Criar diretÃ³rio para Prisma Client
        mkdir -p ../prisma-client
        
        # Extrair Prisma Client do container
        echo "ğŸ“¦ Extracting @prisma directory..."
        docker cp $CONTAINER_ID:/app/node_modules/@prisma ../prisma-client/@prisma || {
          echo "âš ï¸ Failed to extract @prisma, trying alternative..."
          docker cp $CONTAINER_ID:/app/node_modules/@prisma/client ../prisma-client/@prisma-client 2>/dev/null || {
            echo "âŒ Failed to extract Prisma Client"
            docker rm $CONTAINER_ID
            exit 1
          }
        }
        
        # Extrair cache .prisma (contÃ©m os binÃ¡rios para diferentes plataformas)
        echo "ğŸ“¦ Extracting .prisma cache with binaryTargets..."
        docker cp $CONTAINER_ID:/app/node_modules/.prisma ../prisma-client/.prisma || {
          echo "âŒ Failed to extract .prisma cache (required for binaryTargets)"
          docker rm $CONTAINER_ID
          exit 1
        }
        
        # Remover container temporÃ¡rio
        docker rm $CONTAINER_ID
        
        echo "âœ… Prisma Client extracted successfully with binaryTargets:"
        echo "   - native (desenvolvimento)"
        echo "   - debian-openssl-3.0.x (servidor Linode)"
        echo "   - linux-musl-openssl-3.0.x (Docker Alpine)"
        echo ""
        echo "ğŸ“ Prisma Client structure:"
        ls -la ../prisma-client/
        echo ""
        echo "ğŸ“ Binary targets available:"
        ls -la ../prisma-client/.prisma/client/ 2>/dev/null || echo "Using @prisma structure"

    - name: ğŸ¨ Build Frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ¨ Building frontend..."
        npm ci --production=false
        echo "ğŸ“ Generating version info..."
        node scripts/generate-version.cjs
        npm run build
        echo "âœ… Frontend built successfully"

    - name: ğŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸš€ Deploy to Server
      run: |
        echo "ğŸš€ Starting deployment to ${{ secrets.SERVER_HOST }}..."

        # Create temp directory
        DEPLOY_DIR="/tmp/pinovara-deploy-$(date +%s)"
        mkdir -p $DEPLOY_DIR

        # Copy files
        echo "ğŸ“‹ Preparing deployment files (FAST mode)..."
        
        # Copy backend files explicitly (no glob patterns!)
        cp backend/package.json $DEPLOY_DIR/package.json
        cp backend/package-lock.json $DEPLOY_DIR/package-lock.json
        cp -r backend/dist $DEPLOY_DIR/dist
        cp -r backend/prisma $DEPLOY_DIR/prisma
        
        # Copy Prisma Client generated from Docker image
        if [ -d "prisma-client" ]; then
          cp -r prisma-client $DEPLOY_DIR/prisma-client
          echo "âœ… Prisma Client from Docker image copied"
        else
          echo "âš ï¸ Prisma Client not found (will use existing on server or fail)"
        fi
        
        # Copy frontend
        cp -r frontend/dist $DEPLOY_DIR/frontend-dist
        
        echo "ğŸ“¦ Files copied: package.json, package-lock.json, dist/, prisma/"
        echo "âš¡ node_modules will be installed on server (npm ci is faster than copying)"

        # Create env file if config.env exists
        if [ -f "backend/config.env" ]; then
          cp backend/config.env $DEPLOY_DIR/.env
        else
          echo 'NODE_ENV=production' > $DEPLOY_DIR/.env
          echo 'PORT=3001' >> $DEPLOY_DIR/.env
          echo 'DATABASE_URL="postgresql://pinovara:pinovara@bd.pinovaraufba.com.br:5432/pinovara?schema=pinovara"' >> $DEPLOY_DIR/.env
          echo 'JWT_SECRET="pinovara-secret-key-change-in-production"' >> $DEPLOY_DIR/.env
        fi

        # Create PM2 config
        cat > $DEPLOY_DIR/ecosystem.config.js << 'EOF'
        module.exports = {
          apps: [{
            name: 'pinovara-backend',
            script: 'dist/server.js',
            cwd: '/var/www/pinovara/backend',
            instances: 1,
            exec_mode: 'fork',
            env: {
              NODE_ENV: 'production',
              PORT: 3001
            }
          }]
        };
        EOF

        # Copy zero-downtime deploy script to deploy package
        if [ -f "scripts/deploy/deploy-zero-downtime.sh" ]; then
          cp scripts/deploy/deploy-zero-downtime.sh $DEPLOY_DIR/deploy-zero-downtime.sh
          chmod +x $DEPLOY_DIR/deploy-zero-downtime.sh
          echo "âœ… Zero-downtime deploy script included"
        else
          echo "âš ï¸ Zero-downtime script not found, will use inline script"
        fi

        # Create frontend deploy script (simple, no downtime needed)
        cat > $DEPLOY_DIR/deploy-frontend.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸ¨ Deploying frontend..."
        
        BACKUP_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BACKUP_DIR="/var/www/pinovara/backup"
        
        # Backup frontend
        if [ -d "/var/www/html" ] && [ "$(ls -A /var/www/html 2>/dev/null)" ]; then
          echo "ğŸ’¾ Backing up existing frontend..."
          sudo mkdir -p "$BACKUP_DIR/frontend-$BACKUP_TIMESTAMP"
          sudo chown -R $USER:$USER "$BACKUP_DIR/frontend-$BACKUP_TIMESTAMP"
          cp -r /var/www/html/* "$BACKUP_DIR/frontend-$BACKUP_TIMESTAMP/" 2>/dev/null || true
          echo "âœ… Frontend backed up"
        fi
        
        # Deploy new frontend
        sudo mkdir -p /var/www/html
        sudo chown -R $USER:$USER /var/www/html
        rm -rf /var/www/html/* 2>/dev/null || true
        
        if [ -d "$DEPLOY_TMP_DIR/frontend-dist" ]; then
          cp -r "$DEPLOY_TMP_DIR/frontend-dist"/* /var/www/html/
          echo "âœ… Frontend deployed successfully"
        else
          echo "âŒ Frontend files not found"
          exit 1
        fi
        
        # Cleanup old frontend backups (keep last 3)
        cd "$BACKUP_DIR" 2>/dev/null && ls -dt frontend-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
        EOF
        
        chmod +x $DEPLOY_DIR/deploy-frontend.sh

        # Upload and execute zero-downtime deploy
        scp -r $DEPLOY_DIR ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        echo 'ğŸš€ Starting Zero-Downtime Deploy...'
        echo 'ğŸ‘¤ SSH User: ${{ secrets.SERVER_USER }}'
        echo 'ğŸ‘¤ Current user in SSH session: \$(whoami)'
        DEPLOY_TMP_DIR=\$(ls -d /tmp/pinovara-deploy-* | head -1)
        export DEPLOY_TMP_DIR
        
        # Execute zero-downtime backend deploy (bash -l carrega .profile/.bashrc para PM2 no PATH)
        if [ -f \"\$DEPLOY_TMP_DIR/deploy-zero-downtime.sh\" ]; then
          bash -l \$DEPLOY_TMP_DIR/deploy-zero-downtime.sh
        else
          echo 'âŒ Zero-downtime script not found, falling back to standard deploy'
          exit 1
        fi
        
        # Deploy frontend (after backend is confirmed working)
        bash \$DEPLOY_TMP_DIR/deploy-frontend.sh
        "

        # Cleanup
        rm -rf $DEPLOY_DIR
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'rm -rf /tmp/pinovara-deploy-*'

    - name: âœ… Verify Deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        sleep 10

        # Check backend
        if ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'curl -f http://localhost:3001/health > /dev/null 2>&1'; then
          echo "âœ… Backend is running"
        else
          echo "âŒ Backend not responding"
        fi

        # Check frontend
        if ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'curl -f http://localhost/ > /dev/null 2>&1'; then
          echo "âœ… Frontend is running"
        else
          echo "âš ï¸ Frontend may need Nginx configuration"
        fi

        echo "ğŸ‰ Deployment verification complete!"
