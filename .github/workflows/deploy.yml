name: Deploy to Production

# ğŸš€ PINOVARA Deploy v4.2 - ULTRA FAST DEPLOY
# âš¡ SKIP PRISMA - Uses existing client (30 seconds!)
# ğŸ“‹ BACKUP SYSTEM - Timestamp-based backups
# ğŸ› ï¸ Use 'Deploy Full' for Prisma regeneration

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Starting Safe Deploy v4.1
      run: |
        echo "ğŸ¯ PINOVARA Deploy v4.1 - WITH BACKUP SYSTEM"
        echo "âœ… SAFE backup system - Timestamp-based backups"
        echo "âœ… AUTO cleanup - Keeps only last 3 backups"
        echo "ğŸ“… $(date)"

    - name: ğŸ”§ Validate Secrets
      run: |
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âŒ SSH_PRIVATE_KEY secret not configured"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "âŒ SERVER_HOST secret not configured"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "âŒ SERVER_USER secret not configured"
          exit 1
        fi
        echo "âœ… All secrets configured"

    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ—ï¸ Build Backend
      working-directory: ./backend
      run: |
        echo "ğŸ”¨ Building backend..."
        npm ci
        npm run build
        echo "âœ… Backend built successfully (FAST - no Prisma)"

    - name: ğŸ¨ Build Frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ¨ Building frontend..."
        npm ci
        echo "ğŸ“ Generating version info..."
        node scripts/generate-version.cjs
        npm run build
        echo "âœ… Frontend built successfully"

    - name: ğŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸš€ Deploy to Server
      run: |
        echo "ğŸš€ Starting deployment to ${{ secrets.SERVER_HOST }}..."

        # Create temp directory
        DEPLOY_DIR="/tmp/pinovara-deploy-$(date +%s)"
        mkdir -p $DEPLOY_DIR

        # Copy files
        echo "ğŸ“‹ Preparing deployment files (FAST mode)..."
        cp -r backend/package*.json backend/dist backend/prisma $DEPLOY_DIR/ 2>/dev/null || true
        cp -r frontend/dist $DEPLOY_DIR/frontend-dist 2>/dev/null || true
        echo "âš¡ Skipping Prisma client copy (will reuse server's existing client)"

        # Create env file if config.env exists
        if [ -f "backend/config.env" ]; then
          cp backend/config.env $DEPLOY_DIR/.env
        else
          echo 'NODE_ENV=production' > $DEPLOY_DIR/.env
          echo 'PORT=3001' >> $DEPLOY_DIR/.env
          echo 'DATABASE_URL="postgresql://pinovara:pinovara@bd.pinovaraufba.com.br:5432/pinovara?schema=pinovara"' >> $DEPLOY_DIR/.env
          echo 'JWT_SECRET="pinovara-secret-key-change-in-production"' >> $DEPLOY_DIR/.env
        fi

        # Create PM2 config
        cat > $DEPLOY_DIR/ecosystem.config.js << 'EOF'
        module.exports = {
          apps: [{
            name: 'pinovara-backend',
            script: 'dist/server.js',
            cwd: '/var/www/pinovara/backend',
            instances: 1,
            exec_mode: 'fork',
            env: {
              NODE_ENV: 'production',
              PORT: 3001
            }
          }]
        };
        EOF

        # Create deploy script
        cat > $DEPLOY_DIR/deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "ğŸš€ PINOVARA v4.2 - ULTRA FAST DEPLOY STARTING..."
        echo "âš¡ FAST MODE - Reusing existing Prisma client"
        echo "ğŸ“‹ BACKUP system enabled - Creating timestamped backups"

        # Check PM2
        if ! command -v pm2 &> /dev/null; then
          echo "âŒ PM2 not installed"
          exit 1
        fi
        echo "âœ… PM2 available"

        # Backup System - Create timestamped backups before deployment
        BACKUP_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BACKUP_DIR="/var/www/pinovara/backup"
        
        echo "ğŸ’¾ CREATING BACKUPS - Timestamp: $BACKUP_TIMESTAMP"
        
        # Create backup directory structure
        sudo mkdir -p "$BACKUP_DIR"
        sudo chown -R $USER:$USER "$BACKUP_DIR"
        
        # Backup existing backend if it exists
        if [ -d "/var/www/pinovara/backend" ]; then
          echo "ğŸ’¾ Backing up existing backend..."
          mv /var/www/pinovara/backend "$BACKUP_DIR/backend-$BACKUP_TIMESTAMP"
          echo "âœ… Backend backed up to: $BACKUP_DIR/backend-$BACKUP_TIMESTAMP"
        else
          echo "â„¹ï¸ No existing backend to backup"
        fi
        
        # Backup existing frontend if it exists
        if [ -d "/var/www/html" ] && [ "$(ls -A /var/www/html 2>/dev/null)" ]; then
          echo "ğŸ’¾ Backing up existing frontend..."
          sudo mkdir -p "$BACKUP_DIR/frontend-$BACKUP_TIMESTAMP"
          sudo chown -R $USER:$USER "$BACKUP_DIR/frontend-$BACKUP_TIMESTAMP"
          cp -r /var/www/html/* "$BACKUP_DIR/frontend-$BACKUP_TIMESTAMP/" 2>/dev/null || true
          echo "âœ… Frontend backed up to: $BACKUP_DIR/frontend-$BACKUP_TIMESTAMP"
        else
          echo "â„¹ï¸ No existing frontend to backup"
        fi
        
        # Cleanup old backups - keep only last 3 backups of each type
        echo "ğŸ§¹ Cleaning up old backups (keeping last 3)..."
        
        # Clean backend backups
        cd "$BACKUP_DIR" && ls -d backend-* 2>/dev/null | head -n -3 | xargs rm -rf 2>/dev/null || true
        
        # Clean frontend backups
        cd "$BACKUP_DIR" && ls -d frontend-* 2>/dev/null | head -n -3 | xargs rm -rf 2>/dev/null || true
        
        echo "âœ… Backup system completed"

        # Create directories with proper ownership from start
        echo "ğŸ‘¤ Current user: $(whoami)"
        echo "ğŸ‘¤ \$USER variable: $USER"
        sudo mkdir -p /var/www/pinovara
        sudo chown -R $USER:$USER /var/www/pinovara

        # Stop existing processes
        pm2 stop pinovara-backend 2>/dev/null || true
        pm2 delete pinovara-backend 2>/dev/null || true

        # Create fresh backend directory (old one already backed up)
        mkdir -p /var/www/pinovara/backend

        # Copy files with explicit paths
        echo "ğŸ“‹ Deploying backend files..."
        DEPLOY_SOURCE="$DEPLOY_TMP_DIR"
        echo "ğŸ“‚ Source directory: $DEPLOY_SOURCE"
        echo "ğŸ“‚ Target directory: /var/www/pinovara/backend"

        # Navigate to source directory for copying
        cd "$DEPLOY_SOURCE" || { echo "âŒ Failed to cd to $DEPLOY_SOURCE"; exit 1; }

        # Copy files with full paths (no sudo needed now)
        if [ -f "package.json" ]; then
            cp package*.json /var/www/pinovara/backend/
            echo "âœ… package.json copied"
        else
            echo "âŒ package.json not found in $DEPLOY_SOURCE"
        fi

        if [ -f ".env" ]; then
            cp .env /var/www/pinovara/backend/
            echo "âœ… .env copied"
        else
            echo "âŒ .env not found in $DEPLOY_SOURCE"
        fi

        if [ -f "ecosystem.config.js" ]; then
            cp ecosystem.config.js /var/www/pinovara/backend/
            echo "âœ… ecosystem.config.js copied"
        else
            echo "âŒ ecosystem.config.js not found in $DEPLOY_SOURCE"
            ls -la "$DEPLOY_SOURCE"/
        fi

        if [ -d "dist" ]; then
            cp -r dist /var/www/pinovara/backend/
            echo "âœ… dist/ copied"
        else
            echo "âŒ dist/ not found in $DEPLOY_SOURCE"
        fi

        if [ -d "prisma" ]; then
            cp -r prisma /var/www/pinovara/backend/
            echo "âœ… prisma/ copied"
        else
            echo "âŒ prisma/ not found in $DEPLOY_SOURCE"
        fi

        # Navigate to target directory for execution
        cd /var/www/pinovara/backend || { echo "âŒ Failed to cd to /var/www/pinovara/backend"; exit 1; }
        echo "ğŸ“‚ Current directory: $(pwd)"
        echo "ğŸ“ Directory contents: $(ls -la)"

        # Ensure we're in the correct directory and it has the right files
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found in current directory"
          echo "ğŸ“‚ Current dir: $(pwd)"
          echo "ğŸ“ Contents: $(ls -la)"
          exit 1
        fi
        
        sudo chmod -R 777 /var/www/pinovara/backend 

        # Install dependencies with explicit working directory
        echo "ğŸ“¦ Installing dependencies..."
        cd /var/www/pinovara/backend && sudo npm ci --production --unsafe-perm

        # Prisma client strategy (ULTRA SMART!)
        echo "âš¡ Checking existing Prisma client on server..."
        
        # Check if Prisma client already exists on server (from previous deploys)
        if [ -d "/var/www/pinovara/backend/node_modules/@prisma/client" ] && [ -f "/var/www/pinovara/backend/node_modules/@prisma/client/index.js" ]; then
          echo "ğŸ‰ FOUND existing Prisma client on server!"
          echo "âš¡ SKIPPING Prisma generation (ULTRA FAST mode!)"
          echo "ğŸ“ Using existing client from previous deploy"
        else
          echo "ğŸ” No existing Prisma client found on server"
          
          # Try to use pre-generated client from CI
          if [ -d "$DEPLOY_SOURCE/prisma-client" ]; then
            echo "âš¡ Restoring pre-generated client from CI..."
            sudo mkdir -p /var/www/pinovara/backend/node_modules/@prisma
            sudo chown -R $USER:$USER /var/www/pinovara/backend/node_modules/@prisma
            cp -r "$DEPLOY_SOURCE/prisma-client"/* /var/www/pinovara/backend/node_modules/@prisma/
            echo "âœ… Prisma client restored from CI (FAST!)"
          else
            echo "âš ï¸ No pre-generated client available"
            echo "ğŸš‘ Use 'Deploy Full' workflow to regenerate Prisma client"
            echo "ğŸ“ This deploy will use existing client or fail gracefully"
          fi
        fi
        
        # NOTE: Database schema is NEVER modified by deploy
        # System adapts to existing database structure

        # Start application
        echo "ğŸš€ Starting application..."
        echo "ğŸ“‚ Current directory: $(pwd)"
        echo "ğŸ“„ Files in directory: $(ls -la)"

        if [ -f "ecosystem.config.js" ]; then
            echo "âœ… ecosystem.config.js found, starting PM2..."
            pm2 start ecosystem.config.js --env production
            pm2 save
            echo "âœ… Application started successfully"
        else
            echo "âŒ ecosystem.config.js not found in $(pwd)"
            echo "ğŸ“„ Available files:"
            ls -la
            exit 1
        fi

        # Deploy frontend
        echo "ğŸ¨ Deploying frontend..."
        sudo mkdir -p /var/www/html
        sudo chown -R $USER:$USER /var/www/html
        # Frontend backup already done above, now clean and deploy fresh files
        rm -rf /var/www/html/* 2>/dev/null || true
        
        # Navigate to source directory for frontend deployment
        cd "$DEPLOY_TMP_DIR" || { echo "âŒ Failed to cd to $DEPLOY_TMP_DIR"; exit 1; }
        
        if [ -d "frontend-dist" ]; then
          echo "ğŸ“ Found frontend-dist directory"
          ls -la frontend-dist/ | head -5
          cp -r frontend-dist/* /var/www/html/
          echo "âœ… Frontend deployed successfully"
          echo "ğŸ“Š Files in /var/www/html:"
          ls -la /var/www/html/ | head -5
        else
          echo "âŒ Frontend files not found"
          echo "ğŸ“‚ Available directories:"
          ls -la "$DEPLOY_TMP_DIR"
        fi

        echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY!"
        
        # Show backup status
        echo ""
        echo "ğŸ’¾ BACKUP STATUS:"
        if [ -d "$BACKUP_DIR" ]; then
          echo "ğŸ“ Backup directory: $BACKUP_DIR"
          echo "ğŸ“Š Available backups:"
          ls -la "$BACKUP_DIR" | grep -E "(backend-|frontend-)" | tail -10 || echo "   No backups found"
        else
          echo "âš ï¸ No backup directory found"
        fi
        EOF

        chmod +x $DEPLOY_DIR/deploy.sh

        # Upload and execute
        scp -r $DEPLOY_DIR ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        echo 'ğŸ‘¤ SSH User: ${{ secrets.SERVER_USER }}'
        echo 'ğŸ‘¤ Current user in SSH session: \$(whoami)'
        echo 'ğŸ‘¤ \$USER variable in SSH: '\$USER
        DEPLOY_TMP_DIR=\$(ls -d /tmp/pinovara-deploy-* | head -1)
        export DEPLOY_TMP_DIR
        bash \$DEPLOY_TMP_DIR/deploy.sh
        "

        # Cleanup
        rm -rf $DEPLOY_DIR
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'rm -rf /tmp/pinovara-deploy-*'

    - name: âœ… Verify Deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        sleep 10

        # Check backend
        if ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'curl -f http://localhost:3001/health > /dev/null 2>&1'; then
          echo "âœ… Backend is running"
        else
          echo "âŒ Backend not responding"
        fi

        # Check frontend
        if ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'curl -f http://localhost/ > /dev/null 2>&1'; then
          echo "âœ… Frontend is running"
        else
          echo "âš ï¸ Frontend may need Nginx configuration"
        fi

        echo "ğŸ‰ Deployment verification complete!"
