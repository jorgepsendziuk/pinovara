name: Deploy to Production - NO BACKUP v3.0

# Workflow para deploy automÃ¡tico do PINOVARA - v2.1 (backup removido)
# âœ… SEM SISTEMA DE BACKUP - Deploy direto e simples
#
# PrÃ©-requisitos na VM:
# - Node.js 18+
# - PM2 instalado globalmente
# - PostgreSQL configurado
# - Nginx configurado (opcional)
# - Chaves SSH configuradas
#
# Secrets necessÃ¡rias no GitHub:
# - SSH_PRIVATE_KEY: Chave privada SSH
# - SERVER_HOST: pinovaraufba.com.br
# - SERVER_USER: UsuÃ¡rio SSH (ubuntu, etc.)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Validate Configuration
      run: |
        echo "ğŸ”§ Validating deployment configuration..."
        echo "ğŸ“‹ WORKFLOW VERSION: Deploy to Production - NO BACKUP v3.0"
        echo "âœ… This version has NO backup system - direct deployment only"
        echo ""
        echo "ğŸ“‹ REQUIRED GitHub Secrets Configuration:"
        echo "=========================================="
        echo ""
        echo "Go to: Repository Settings â†’ Secrets and variables â†’ Actions"
        echo ""
        echo "Add these secrets:"
        echo ""
        echo "1. SSH_PRIVATE_KEY"
        echo "   How to get the value:"
        echo "   â€¢ Run: cat ~/.ssh/id_rsa"
        echo "   â€¢ Copy the ENTIRE output (including -----BEGIN OPENSSH PRIVATE KEY-----)"
        echo "   â€¢ Make sure to include all lines with proper line breaks"
        echo ""
        echo "2. SERVER_HOST"
        echo "   Value: pinovaraufba.com.br"
        echo ""
        echo "3. SERVER_USER"
        echo "   Value: ubuntu"
        echo "   (or your SSH username on the server)"
        echo ""
        echo "âŒ Deployment will fail until these secrets are configured!"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Cache backend dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          ./backend/node_modules
        key: ${{ runner.os }}-backend-node-${{ hashFiles('backend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-backend-node-

    - name: Install backend dependencies
      working-directory: ./backend
      run: npm ci

    - name: Build backend
      working-directory: ./backend
      run: |
        echo "ğŸ”¨ Construindo backend..."
        npm run build
        echo "âœ… Build do backend concluÃ­do"
        echo "ğŸ“ Arquivos gerados: $(ls -la dist/)"

    - name: Verify backend build
      run: |
        echo "ğŸ” Verificando build do backend..."
        if [ -d "backend/dist" ]; then
          echo "âœ… DiretÃ³rio backend/dist encontrado"
          echo "ğŸ“„ Arquivos em dist/: $(ls backend/dist/ | wc -l) arquivos"
          if [ -f "backend/package.json" ]; then
            echo "âœ… package.json encontrado"
          else
            echo "âŒ package.json nÃ£o encontrado"
            exit 1
          fi
          if [ -f "backend/package-lock.json" ]; then
            echo "âœ… package-lock.json encontrado"
          else
            echo "âŒ package-lock.json nÃ£o encontrado"
            exit 1
          fi
        else
          echo "âŒ DiretÃ³rio backend/dist nÃ£o encontrado!"
          exit 1
        fi

    - name: Cache frontend dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          ./frontend/node_modules
        key: ${{ runner.os }}-frontend-node-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-node-

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Build frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ¨ Construindo frontend..."
        npm run build
        echo "âœ… Build do frontend concluÃ­do"
        echo "ğŸ“ Arquivos gerados: $(ls -la dist/)"

    - name: Verify frontend build
      run: |
        echo "ğŸ” Verificando build do frontend..."
        if [ -d "frontend/dist" ]; then
          echo "âœ… DiretÃ³rio frontend/dist encontrado"
          echo "ğŸ“„ Arquivos em dist/: $(ls frontend/dist/ | wc -l) arquivos"
          if [ -f "frontend/dist/index.html" ]; then
            echo "âœ… index.html encontrado"
          else
            echo "âŒ index.html nÃ£o encontrado"
          fi
        else
          echo "âŒ DiretÃ³rio frontend/dist nÃ£o encontrado!"
          exit 1
        fi

    - name: Setup SSH
      run: |
        # Validate required secrets
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âŒ Error: SSH_PRIVATE_KEY secret is not configured"
          exit 1
        fi

        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "âŒ Error: SERVER_HOST secret is not configured"
          exit 1
        fi

        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "âŒ Error: SERVER_USER secret is not configured"
          exit 1
        fi

        echo "âœ… All required secrets are configured"

        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        # Verificar estrutura de arquivos antes do deploy
        echo "ğŸ” Verificando estrutura de arquivos no repositÃ³rio..."
        echo "ğŸ“ DiretÃ³rio atual: $(pwd)"
        echo "ğŸ“ ConteÃºdo da raiz: $(ls -la)"

        if [ -d "backend" ]; then
          echo "âœ… DiretÃ³rio backend encontrado"
          echo "ğŸ“ ConteÃºdo do backend: $(ls -la backend/)"
        else
          echo "âŒ DiretÃ³rio backend nÃ£o encontrado!"
          exit 1
        fi

        if [ -d "frontend" ]; then
          echo "âœ… DiretÃ³rio frontend encontrado"
          echo "ğŸ“ ConteÃºdo do frontend: $(ls -la frontend/)"
        else
          echo "âŒ DiretÃ³rio frontend nÃ£o encontrado!"
          exit 1
        fi

        # Criar diretÃ³rio temporÃ¡rio para arquivos
        DEPLOY_DIR="/tmp/pinovara-deploy-$(date +%s)"
        mkdir -p $DEPLOY_DIR

        # Copiar arquivos necessÃ¡rios
        echo "ğŸ“¦ Preparando arquivos para deploy..."
        echo "ğŸ“ ConteÃºdo do DEPLOY_DIR antes da cÃ³pia: $(ls -la $DEPLOY_DIR 2>/dev/null || echo 'DEPLOY_DIR vazio')"
        echo "ğŸ“ DEPLOY_DIR path: $DEPLOY_DIR"

        # Verificar arquivos antes de copiar
        echo "ğŸ” Verificando arquivos a serem copiados..."
        [ -f "backend/package.json" ] && echo "âœ… backend/package.json existe" || echo "âŒ backend/package.json nÃ£o encontrado"
        [ -f "backend/package-lock.json" ] && echo "âœ… backend/package-lock.json existe" || echo "âŒ backend/package-lock.json nÃ£o encontrado"
        [ -d "backend/dist" ] && echo "âœ… backend/dist existe" || echo "âŒ backend/dist nÃ£o encontrado"
        [ -d "backend/prisma" ] && echo "âœ… backend/prisma existe" || echo "âŒ backend/prisma nÃ£o encontrado"
        [ -f "backend/prisma/schema.prisma" ] && echo "âœ… backend/prisma/schema.prisma existe" || echo "âŒ backend/prisma/schema.prisma nÃ£o encontrado"
        [ -d "frontend/dist" ] && echo "âœ… frontend/dist existe" || echo "âŒ frontend/dist nÃ£o encontrado"

        # Copiar arquivos com verificaÃ§Ã£o detalhada
        echo "ğŸ“‹ Iniciando cÃ³pia de arquivos..."

        if [ -f "backend/package.json" ]; then
          cp backend/package.json $DEPLOY_DIR/ && echo "âœ… package.json copiado"
        fi

        if [ -f "backend/package-lock.json" ]; then
          cp backend/package-lock.json $DEPLOY_DIR/ && echo "âœ… package-lock.json copiado"
        else
          echo "âš ï¸ package-lock.json nÃ£o encontrado. Gerando..."
          cd backend && npm install --package-lock-only && cd ..
          if [ -f "backend/package-lock.json" ]; then
            cp backend/package-lock.json $DEPLOY_DIR/ && echo "âœ… package-lock.json gerado e copiado"
          fi
        fi

        if [ -d "backend/dist" ]; then
          cp -r backend/dist $DEPLOY_DIR/ && echo "âœ… backend/dist copiado"
        fi

        if [ -d "backend/prisma" ]; then
          cp -r backend/prisma $DEPLOY_DIR/ && echo "âœ… backend/prisma copiado"
        fi

        if [ -d "frontend/dist" ]; then
          cp -r frontend/dist $DEPLOY_DIR/frontend-dist && echo "âœ… frontend/dist copiado"
        fi

        echo "ğŸ“ ConteÃºdo do DEPLOY_DIR apÃ³s cÃ³pia: $(ls -la $DEPLOY_DIR)"

        # Verificar se arquivo de configuraÃ§Ã£o existe
        if [ -f "backend/config.env" ]; then
          cp backend/config.env $DEPLOY_DIR/
          echo "âœ… config.env encontrado e copiado"
        else
          echo "âš ï¸ config.env nÃ£o encontrado. Criando configuraÃ§Ã£o bÃ¡sica..."
          echo 'NODE_ENV=production' > $DEPLOY_DIR/.env
          echo 'PORT=3001' >> $DEPLOY_DIR/.env
          echo 'DATABASE_URL="postgresql://user:password@localhost:5432/pinovara"' >> $DEPLOY_DIR/.env
          echo 'JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"' >> $DEPLOY_DIR/.env
          echo "âœ… Arquivo .env criado"
        fi

        echo "ğŸ“ Arquivos finais no DEPLOY_DIR: $(ls -la $DEPLOY_DIR)"

        # Arquivo de configuraÃ§Ã£o do PM2
        cat > $DEPLOY_DIR/ecosystem.config.js << 'EOF'
        module.exports = {
          apps: [{
            name: 'pinovara-backend',
            script: 'dist/server.js',
            cwd: '/var/www/pinovara/backend',
            instances: 1,
            exec_mode: 'fork',
            env: {
              NODE_ENV: 'production',
              PORT: 3001
            },
            env_production: {
              NODE_ENV: 'production',
              PORT: 3001
            }
          }]
        };
        EOF

        # Script de deploy
        cat > $DEPLOY_DIR/deploy.sh << EOF
        #!/bin/bash
        set -e

        echo "ğŸš€ Iniciando deploy do PINOVARA v2.1 (SEM BACKUP)..."
        echo "âœ… Modo: Deploy direto - sem sistema de backup"

        # Navegar para o diretÃ³rio dos arquivos de deploy
        DEPLOY_TMP_DIR="/tmp/$(basename $DEPLOY_DIR)"
        cd \$DEPLOY_TMP_DIR || exit 1
        echo "ğŸ“ DiretÃ³rio atual: \$(pwd)"
        echo "ğŸ“ DEPLOY_TMP_DIR: \$DEPLOY_TMP_DIR"
        echo "ğŸ“ Arquivos disponÃ­veis: \$(ls -la)"
        echo "ğŸ“ Arquivos de deploy encontrados:"
        ls -la | grep -E "(deploy|package|dist|prisma|frontend|\.env)" || echo "âš ï¸ Alguns arquivos podem estar faltando"

        # Verificar se PM2 estÃ¡ instalado
        if ! command -v pm2 &> /dev/null; then
          echo "âŒ PM2 nÃ£o estÃ¡ instalado. Instale com: npm install -g pm2"
          exit 1
        fi

        echo "âœ… PM2 estÃ¡ instalado"

        # Verificar se sudo estÃ¡ disponÃ­vel
        if sudo -n true 2>/dev/null; then
          echo "âœ… sudo estÃ¡ disponÃ­vel e configurado"
        else
          echo "âš ï¸ sudo pode nÃ£o estar disponÃ­vel ou requer senha"
          echo "â„¹ï¸ Isso pode causar problemas com operaÃ§Ãµes de arquivo"
        fi

        # Debug de usuÃ¡rio (para troubleshooting)ok
        echo "ğŸ” Debug: USER='$USER', whoami='$(whoami)', id='$(id -un 2>/dev/null || echo "N/A")'"

        # FunÃ§Ã£o para rollback em caso de erro
        rollback() {
          echo "âŒ Erro durante o deploy. Executando rollback..."
          # Stop and delete PM2 process if it exists
          if pm2 list 2>/dev/null | grep -q pinovara-backend; then
            pm2 stop pinovara-backend 2>/dev/null || true
            pm2 delete pinovara-backend 2>/dev/null || true
          fi
          exit 1
        }

        trap rollback ERR

        # Criar diretÃ³rios
        sudo mkdir -p /var/www/pinovara || echo "âš ï¸ NÃ£o foi possÃ­vel criar diretÃ³rio base"

        # Configurar permissÃµes - abordagem simplificada
        # Temporariamente desabilitar trap para chown operations
        trap - ERR
        echo "ğŸ” Configurando permissÃµes do diretÃ³rio..."

        # MÃ©todo 1: Usar stat para obter o proprietÃ¡rio atual
        CURRENT_OWNER=$(stat -c '%U' /var/www 2>/dev/null || echo "www-data")
        echo "ğŸ‘¤ ProprietÃ¡rio atual detectado: $CURRENT_OWNER"

        # MÃ©todo 2: Se for runner ou vazio, tentar detectar o usuÃ¡rio SSH
        if [ "$CURRENT_OWNER" = "runner" ] || [ -z "$CURRENT_OWNER" ] || [ "$CURRENT_OWNER" = "root" ]; then
          # Tentar obter o usuÃ¡rio SSH da conexÃ£o
          SSH_USER=$(who | grep -oP '\w+(?=\s+pts)' | head -1 || echo "www-data")
          if [ -n "$SSH_USER" ] && [ "$SSH_USER" != "runner" ]; then
            CURRENT_OWNER="$SSH_USER"
          else
            CURRENT_OWNER="www-data"
          fi
          echo "ğŸ‘¤ UsuÃ¡rio SSH detectado: $CURRENT_OWNER"
        fi

        # Aplicar permissÃµes de forma segura
        echo "ğŸ”§ Tentando chown -R $CURRENT_OWNER:$CURRENT_OWNER /var/www/pinovara"
        if sudo chown -R $CURRENT_OWNER:$CURRENT_OWNER /var/www/pinovara 2>/dev/null; then
          echo "âœ… PermissÃµes chown configuradas para $CURRENT_OWNER"
        else
          echo "âš ï¸ chown falhou, tentando chmod -R 755"
          if sudo chmod -R 755 /var/www/pinovara 2>/dev/null; then
            echo "â„¹ï¸ Usando permissÃµes padrÃ£o (755) - chown nÃ£o disponÃ­vel"
          else
            echo "âŒ NÃ£o foi possÃ­vel configurar permissÃµes. Isso pode causar problemas..."
          fi
        fi

        # Reabilitar trap apÃ³s operaÃ§Ãµes de chown
        trap rollback ERR

        

        # Deploy do backend
        echo "ğŸ“¦ Deploying backend..."
        if [ -d "/var/www/pinovara/backend" ]; then
          cd /var/www/pinovara/backend
          # Stop and delete PM2 process if it exists
          if pm2 list | grep -q pinovara-backend; then
            echo "ğŸ›‘ Stopping existing PM2 process..."
            pm2 stop pinovara-backend 2>/dev/null || true
            pm2 delete pinovara-backend 2>/dev/null || true
          fi
        fi

        sudo rm -rf /var/www/pinovara/backend || echo "âš ï¸ NÃ£o foi possÃ­vel remover diretÃ³rio backend antigo"
        sudo mkdir -p /var/www/pinovara/backend || echo "âš ï¸ NÃ£o foi possÃ­vel criar diretÃ³rio backend"

        # Copy deployment files to backend directory
        echo "ğŸ“‹ Copiando arquivos de deploy..."

        # Debug: Check what files exist
        echo "ğŸ” Verificando arquivos disponÃ­veis para cÃ³pia:"
        [ -f "package.json" ] && echo "âœ… package.json encontrado" || echo "âŒ package.json nÃ£o encontrado"
        [ -f "ecosystem.config.js" ] && echo "âœ… ecosystem.config.js encontrado" || echo "âŒ ecosystem.config.js nÃ£o encontrado"
        [ -d "dist" ] && echo "âœ… dist/ encontrado" || echo "âŒ dist/ nÃ£o encontrado"
        [ -d "prisma" ] && echo "âœ… prisma/ encontrado" || echo "âŒ prisma/ nÃ£o encontrado"
        [ -f ".env" ] && echo "âœ… .env encontrado" || echo "âŒ .env nÃ£o encontrado"

        # Copy files with detailed logging
        if [ -f "package.json" ]; then
          echo "ğŸ“„ Copiando package.json..."
          sudo cp package*.json /var/www/pinovara/backend/ && echo "âœ… package.json copiado"
        fi

        if [ -f "ecosystem.config.js" ]; then
          echo "ğŸ“„ Copiando ecosystem.config.js..."
          sudo cp ecosystem.config.js /var/www/pinovara/backend/ && echo "âœ… ecosystem.config.js copiado"
        fi

        if [ -d "dist" ]; then
          echo "ğŸ“ Copiando dist/..."
          sudo cp -r dist /var/www/pinovara/backend/ && echo "âœ… dist/ copiado"
        fi

        if [ -d "prisma" ]; then
          echo "ğŸ“ Copiando prisma/..."
          sudo cp -r prisma /var/www/pinovara/backend/ && echo "âœ… prisma/ copiado"
        fi

        if [ -f ".env" ]; then
          echo "ğŸ“„ Copiando .env..."
          sudo cp .env /var/www/pinovara/backend/ && echo "âœ… .env copiado"
        fi

        cd /var/www/pinovara/backend
        echo "ğŸ“ DiretÃ³rio final: $(pwd)"
        echo "ğŸ“ Arquivos no diretÃ³rio backend: $(ls -la)"

        # Instalar dependÃªncias de produÃ§Ã£o
        echo "ğŸ“¦ Instalando dependÃªncias..."
        npm ci --production

        # Configurar banco de dados
        echo "ğŸ—„ï¸ Configurando banco de dados..."
        npx prisma generate
        npx prisma db push --accept-data-loss || npx prisma db push

        # Iniciar aplicaÃ§Ã£o com PM2
        echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
        echo "ğŸ“ DiretÃ³rio atual: $(pwd)"
        echo "ğŸ“ Arquivos no diretÃ³rio: $(ls -la)"

        # Ensure PM2 daemon is running
        pm2 ping 2>/dev/null || pm2 resurrect 2>/dev/null || true

        # Start the application
        if [ -f "ecosystem.config.js" ]; then
          echo "ğŸ“„ Encontrado ecosystem.config.js"
          if pm2 start ecosystem.config.js --env production; then
            echo "âœ… AplicaÃ§Ã£o iniciada com sucesso"
            pm2 save 2>/dev/null || true
            pm2 list
          else
            echo "âŒ Falha ao iniciar aplicaÃ§Ã£o com PM2"
            pm2 logs pinovara-backend --lines 10 2>/dev/null || echo "NÃ£o foi possÃ­vel obter logs do PM2"
            exit 1
          fi
        else
          echo "âŒ Arquivo ecosystem.config.js nÃ£o encontrado!"
          ls -la
          exit 1
        fi

        # Aguardar aplicaÃ§Ã£o iniciar
        echo "â³ Aguardando aplicaÃ§Ã£o iniciar..."
        sleep 10

        # Verificar se aplicaÃ§Ã£o estÃ¡ funcionando
        if curl -f http://localhost:3001/health > /dev/null 2>&1; then
          echo "âœ… Backend estÃ¡ funcionando!"
        else
          echo "âŒ Backend nÃ£o estÃ¡ respondendo. Verificando logs..."
          pm2 logs pinovara-backend --lines 20
          rollback
        fi

        # Deploy do frontend
        echo "ğŸ¨ Deploying frontend..."
        sudo mkdir -p /var/www/html
        sudo rm -rf /var/www/html/* || echo "âš ï¸ NÃ£o foi possÃ­vel limpar diretÃ³rio html"

        # Copy frontend files from deployment directory
        if [ -d "frontend-dist" ]; then
          echo "ğŸ“‹ Copiando arquivos do frontend..."
          sudo cp -r frontend-dist/* /var/www/html/ && echo "âœ… Frontend copiado com sucesso"
        else
          echo "âš ï¸ DiretÃ³rio frontend-dist nÃ£o encontrado no diretÃ³rio atual"
          ls -la | grep frontend || echo "Nenhum arquivo frontend encontrado"
        fi

        # Verificar se frontend estÃ¡ acessÃ­vel
        if curl -f http://localhost/ > /dev/null 2>&1; then
          echo "âœ… Frontend estÃ¡ funcionando!"
        else
          echo "âš ï¸ Aviso: Frontend pode nÃ£o estar configurado corretamente"
        fi

        echo ""
        echo "ğŸ“Š RESUMO DO DEPLOY:"
        echo "===================="

        # Verificar status final
        if pm2 list 2>/dev/null | grep -q pinovara-backend; then
          echo "âœ… PM2: Processo pinovara-backend estÃ¡ rodando"
          pm2 list | grep pinovara-backend || echo "âš ï¸ Detalhes do PM2 nÃ£o disponÃ­veis"
        else
          echo "âŒ PM2: Processo pinovara-backend nÃ£o encontrado"
        fi

        if [ -d "/var/www/pinovara/backend" ]; then
          echo "âœ… Backend: DiretÃ³rio existe"
          ls -la /var/www/pinovara/backend/ | wc -l | xargs echo "   Arquivos no backend:" || echo "   âš ï¸ NÃ£o foi possÃ­vel contar arquivos"
        else
          echo "âŒ Backend: DiretÃ³rio nÃ£o existe"
        fi

        if [ -d "/var/www/html" ]; then
          echo "âœ… Frontend: DiretÃ³rio existe"
          ls -la /var/www/html/ | wc -l | xargs echo "   Arquivos no frontend:" || echo "   âš ï¸ NÃ£o foi possÃ­vel contar arquivos"
        else
          echo "âŒ Frontend: DiretÃ³rio nÃ£o existe"
        fi

        echo ""
        echo "ğŸŒ URLs esperadas:"
        echo "   Backend API: http://localhost:3001"
        echo "   Frontend: http://localhost/"
        echo "   Health Check: http://localhost:3001/health"

        echo ""
        echo "âœ… Deploy concluÃ­do com sucesso!"
        echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: http://pinovaraufba.com.br"
        EOF

        chmod +x $DEPLOY_DIR/deploy.sh

        # Enviar arquivos para o servidor
        echo "ğŸ“¤ Enviando arquivos para o servidor..."
        echo "ğŸ“ Enviando diretÃ³rio: $DEPLOY_DIR"
        scp -r $DEPLOY_DIR ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

        # Listar arquivos enviados para debug
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
          echo "ğŸ“ Todos os arquivos em /tmp/:"
          ls -la /tmp/
          echo ""
          echo "ğŸ“ ConteÃºdo do diretÃ³rio de deploy:"
          ls -la /tmp/pinovara-deploy-* 2>/dev/null || echo "âš ï¸ DiretÃ³rio de deploy nÃ£o encontrado"
          echo ""
          echo "ğŸ“ Arquivos no diretÃ³rio de deploy:"
          ls -la /tmp/pinovara-deploy-*/ 2>/dev/null | grep -E "(deploy|package|dist|prisma|frontend|\.env|\.js)" || echo "âš ï¸ Alguns arquivos podem nÃ£o ter sido encontrados"
        '

        # Executar deploy no servidor
        echo "ğŸš€ Executando script de deploy..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash /tmp/pinovara-deploy-*/deploy.sh'

        # Limpar arquivos temporÃ¡rios
        rm -rf $DEPLOY_DIR
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'rm -rf /tmp/pinovara-deploy-*'

    - name: Verify deployment
      run: |
        echo "ğŸ” Verificando deploy..."

        # Aguardar um pouco mais para garantir que tudo estÃ¡ funcionando
        sleep 15

        # Verificar status do PM2
        echo "ğŸ“Š Verificando status do PM2..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'pm2 list'

        # Verificar se o backend estÃ¡ rodando
        echo "ğŸ”§ Verificando backend..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "if curl -f --max-time 10 http://localhost:3001/health; then echo 'âœ… Backend estÃ¡ funcionando!'; else echo 'âŒ Backend nÃ£o estÃ¡ respondendo na porta 3001'; pm2 logs pinovara-backend --lines 10; exit 1; fi"

        # Verificar se o frontend estÃ¡ acessÃ­vel
        echo "ğŸ¨ Verificando frontend..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "if curl -f --max-time 10 http://localhost/; then echo 'âœ… Frontend estÃ¡ funcionando!'; else echo 'âš ï¸ Frontend pode nÃ£o estar configurado (Nginx necessÃ¡rio)'; echo 'Verificando se os arquivos estÃ£o no lugar...'; ls -la /var/www/html/ | head -5; fi"

        echo "âœ… Deploy verificado com sucesso!"
        echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: http://pinovaraufba.com.br"

    - name: Notify on success
      if: success()
      run: |
        echo "ğŸ‰ Deploy realizado com sucesso!"
        echo "ğŸ“… $(date)"
        echo "ğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Deploy falhou!"
        echo "ğŸ“… $(date)"
        echo "ğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "Verifique os logs para mais detalhes."

    - name: Cleanup
      if: always()
      run: |
        rm -rf ~/.ssh/id_rsa
