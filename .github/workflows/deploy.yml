name: Deploy to Production

# üöÄ PINOVARA Deploy v4.0 - CLEAN & SIMPLE
# ‚úÖ NO BACKUP SYSTEM - Direct deployment only
# ‚úÖ NO COMPLEXITY - Just deploy and go

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üöÄ Starting Clean Deploy v4.0
      run: |
        echo "üéØ PINOVARA Deploy v4.0 - CLEAN & SIMPLE"
        echo "‚úÖ NO backup system - Direct deployment only"
        echo "‚úÖ NO complexity - Just deploy and go"
        echo "üìÖ $(date)"

    - name: üîß Validate Secrets
      run: |
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "‚ùå SSH_PRIVATE_KEY secret not configured"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "‚ùå SERVER_HOST secret not configured"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "‚ùå SERVER_USER secret not configured"
          exit 1
        fi
        echo "‚úÖ All secrets configured"

    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: üèóÔ∏è Build Backend
      working-directory: ./backend
      run: |
        echo "üî® Building backend..."
        npm ci
        npm run build
        echo "‚úÖ Backend built successfully"

    - name: üé® Build Frontend
      working-directory: ./frontend
      run: |
        echo "üé® Building frontend..."
        npm ci
        npm run build
        echo "‚úÖ Frontend built successfully"

    - name: üîê Setup SSH
      run: |
        echo "üîê Setting up SSH connection..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Write the private key and ensure correct format
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Check key format and convert if needed
        KEY_HEADER=$(head -n1 ~/.ssh/id_rsa)
        echo "üîç Key format detected: $KEY_HEADER"
        
        if [[ "$KEY_HEADER" == *"BEGIN RSA PRIVATE KEY"* ]]; then
          echo "üìã RSA format detected - ensuring compatibility..."
          # For RSA format, we may need to convert to OpenSSH format
          if command -v ssh-keygen >/dev/null 2>&1; then
            # Try to convert RSA to OpenSSH format
            if ssh-keygen -p -m OpenSSH -f ~/.ssh/id_rsa -N "" > /dev/null 2>&1; then
              echo "‚úÖ Converted RSA key to OpenSSH format"
            else
              echo "‚ÑπÔ∏è Using RSA key as-is (conversion not needed)"
            fi
          fi
        elif [[ "$KEY_HEADER" == *"BEGIN OPENSSH PRIVATE KEY"* ]]; then
          echo "‚úÖ OpenSSH format detected"
        else
          echo "‚ö†Ô∏è Unknown key format: $KEY_HEADER"
        fi
        
        # Validate the key can be used
        if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
          echo "‚ùå SSH key validation failed"
          echo "üîç Key starts with: $(head -n1 ~/.ssh/id_rsa | cut -c1-50)"
          echo "üîç Key ends with: $(tail -n1 ~/.ssh/id_rsa | cut -c1-50)"
          # Try alternative validation
          echo "üîß Trying alternative key validation..."
          if openssl rsa -in ~/.ssh/id_rsa -check -noout > /dev/null 2>&1; then
            echo "‚úÖ Key validated with OpenSSL"
          else
            echo "‚ùå Key validation failed completely"
            exit 1
          fi
        else
          echo "‚úÖ SSH private key format is valid"
        fi
        
        # Add server to known hosts
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        
        # Create SSH config for better connection handling
        cat >> ~/.ssh/config << EOF
        Host deploy-server
            HostName ${{ secrets.SERVER_HOST }}
            User ${{ secrets.SERVER_USER }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking accept-new
            ConnectTimeout 30
            ServerAliveInterval 60
            ServerAliveCountMax 3
        EOF
        chmod 600 ~/.ssh/config
        
        # Test SSH connection
        echo "üîç Testing SSH connection..."
        if ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'echo "SSH connection successful"'; then
          echo "‚úÖ SSH connection test passed"
        else
          echo "‚ùå SSH connection test failed"
          echo "üîç Debugging SSH connection..."
          ssh -vvv -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'echo "Debug connection"' || true
          exit 1
        fi

    - name: üöÄ Deploy to Server
      run: |
        echo "üöÄ Starting deployment to ${{ secrets.SERVER_HOST }}..."

        # Create temp directory
        DEPLOY_DIR="/tmp/pinovara-deploy-$(date +%s)"
        mkdir -p $DEPLOY_DIR

        # Copy files
        echo "üìã Preparing deployment files..."
        cp -r backend/package*.json backend/dist backend/prisma $DEPLOY_DIR/ 2>/dev/null || true
        cp -r frontend/dist $DEPLOY_DIR/frontend-dist 2>/dev/null || true

        # Create env file if config.env exists
        if [ -f "backend/config.env" ]; then
          cp backend/config.env $DEPLOY_DIR/.env
        else
          echo 'NODE_ENV=production' > $DEPLOY_DIR/.env
          echo 'PORT=3001' >> $DEPLOY_DIR/.env
          echo 'DATABASE_URL="postgresql://pinovara:pinovara@bd.pinovaraufba.com.br:5432/pinovara?schema=pinovara"' >> $DEPLOY_DIR/.env
          echo 'JWT_SECRET="pinovara-secret-key-change-in-production"' >> $DEPLOY_DIR/.env
        fi

        # Create PM2 config
        cat > $DEPLOY_DIR/ecosystem.config.js << 'EOF'
        module.exports = {
          apps: [{
            name: 'pinovara-backend',
            script: 'dist/server.js',
            cwd: '/var/www/pinovara/backend',
            instances: 1,
            exec_mode: 'fork',
            env: {
              NODE_ENV: 'production',
              PORT: 3001
            }
          }]
        };
        EOF

        # Create deploy script
        cat > $DEPLOY_DIR/deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "üöÄ PINOVARA v4.0 - CLEAN DEPLOY STARTING..."
        echo "‚úÖ NO backup system - Direct deployment"

        # Check PM2
        if ! command -v pm2 &> /dev/null; then
          echo "‚ùå PM2 not installed"
          exit 1
        fi
        echo "‚úÖ PM2 available"

        # Create directories with proper ownership from start
        echo "üë§ Current user: $(whoami)"
        echo "üë§ \$USER variable: $USER"
        sudo mkdir -p /var/www/pinovara
        sudo chown -R $USER:$USER /var/www/pinovara

        # Stop existing processes
        pm2 stop pinovara-backend 2>/dev/null || true
        pm2 delete pinovara-backend 2>/dev/null || true

        # Remove old backend (now with proper ownership)
        rm -rf /var/www/pinovara/backend
        mkdir -p /var/www/pinovara/backend

        # Copy files with explicit paths
        echo "üìã Deploying backend files..."
        DEPLOY_SOURCE="$DEPLOY_TMP_DIR"
        echo "üìÇ Source directory: $DEPLOY_SOURCE"
        echo "üìÇ Target directory: /var/www/pinovara/backend"

        # Navigate to source directory for copying
        cd "$DEPLOY_SOURCE" || { echo "‚ùå Failed to cd to $DEPLOY_SOURCE"; exit 1; }

        # Copy files with full paths (no sudo needed now)
        if [ -f "package.json" ]; then
            cp package*.json /var/www/pinovara/backend/
            echo "‚úÖ package.json copied"
        else
            echo "‚ùå package.json not found in $DEPLOY_SOURCE"
        fi

        if [ -f ".env" ]; then
            cp .env /var/www/pinovara/backend/
            echo "‚úÖ .env copied"
        else
            echo "‚ùå .env not found in $DEPLOY_SOURCE"
        fi

        if [ -f "ecosystem.config.js" ]; then
            cp ecosystem.config.js /var/www/pinovara/backend/
            echo "‚úÖ ecosystem.config.js copied"
        else
            echo "‚ùå ecosystem.config.js not found in $DEPLOY_SOURCE"
            ls -la "$DEPLOY_SOURCE"/
        fi

        if [ -d "dist" ]; then
            cp -r dist /var/www/pinovara/backend/
            echo "‚úÖ dist/ copied"
        else
            echo "‚ùå dist/ not found in $DEPLOY_SOURCE"
        fi

        if [ -d "prisma" ]; then
            cp -r prisma /var/www/pinovara/backend/
            echo "‚úÖ prisma/ copied"
        else
            echo "‚ùå prisma/ not found in $DEPLOY_SOURCE"
        fi

        # Navigate to target directory for execution
        cd /var/www/pinovara/backend || { echo "‚ùå Failed to cd to /var/www/pinovara/backend"; exit 1; }
        echo "üìÇ Current directory: $(pwd)"
        echo "üìÅ Directory contents: $(ls -la)"

        # Ensure we're in the correct directory and it has the right files
        if [ ! -f "package.json" ]; then
          echo "‚ùå package.json not found in current directory"
          echo "üìÇ Current dir: $(pwd)"
          echo "üìÅ Contents: $(ls -la)"
          exit 1
        fi
        
        sudo chmod -R 777 /var/www/pinovara/backend 

        # Install dependencies with explicit working directory
        echo "üì¶ Installing dependencies..."
        cd /var/www/pinovara/backend && sudo npm ci --production --unsafe-perm

        # Database setup with explicit directory
        echo "üóÑÔ∏è Setting up database..."
        cd /var/www/pinovara/backend && sudo npx prisma generate
        
        # Use migrations for production safety (no data loss)
        if cd /var/www/pinovara/backend && sudo npx prisma migrate status; then
          echo "üìä Applying pending migrations..."
          cd /var/www/pinovara/backend && sudo npx prisma migrate deploy
        else
          echo "‚ö†Ô∏è No migrations found, using db push (CAREFUL!)"
          cd /var/www/pinovara/backend && sudo npx prisma db push
        fi

        # Start application
        echo "üöÄ Starting application..."
        echo "üìÇ Current directory: $(pwd)"
        echo "üìÑ Files in directory: $(ls -la)"

        if [ -f "ecosystem.config.js" ]; then
            echo "‚úÖ ecosystem.config.js found, starting PM2..."
            pm2 start ecosystem.config.js --env production
            pm2 save
            echo "‚úÖ Application started successfully"
        else
            echo "‚ùå ecosystem.config.js not found in $(pwd)"
            echo "üìÑ Available files:"
            ls -la
            exit 1
        fi

        # Deploy frontend
        echo "üé® Deploying frontend..."
        sudo mkdir -p /var/www/html
        sudo chown -R $USER:$USER /var/www/html
        rm -rf /var/www/html/*
        if [ -d "../frontend-dist" ]; then
          cp -r ../frontend-dist/* /var/www/html/
          echo "‚úÖ Frontend deployed"
        else
          echo "‚ö†Ô∏è Frontend files not found"
        fi

        echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        EOF

        chmod +x $DEPLOY_DIR/deploy.sh

        # Upload and execute with retry mechanism
        echo "üì§ Uploading files to server..."
        for i in {1..3}; do
          if scp -o ConnectTimeout=30 -o ServerAliveInterval=60 -r $DEPLOY_DIR ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/; then
            echo "‚úÖ Files uploaded successfully"
            break
          else
            echo "‚ö†Ô∏è Upload attempt $i failed, retrying..."
            sleep 5
          fi
        done
        
        echo "üöÄ Executing deployment script..."
        ssh -o ConnectTimeout=30 -o ServerAliveInterval=60 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        echo 'üë§ SSH User: ${{ secrets.SERVER_USER }}'
        echo 'üë§ Current user in SSH session: \$(whoami)'
        echo 'üë§ \$USER variable in SSH: '\$USER
        DEPLOY_TMP_DIR=\$(ls -d /tmp/pinovara-deploy-* | head -1)
        export DEPLOY_TMP_DIR
        timeout 300 bash \$DEPLOY_TMP_DIR/deploy.sh
        "

        # Cleanup
        rm -rf $DEPLOY_DIR
        echo "üßπ Cleaning up temporary files..."
        ssh -o ConnectTimeout=30 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'rm -rf /tmp/pinovara-deploy-*'

    - name: ‚úÖ Verify Deployment
      run: |
        echo "üîç Verifying deployment..."
        sleep 15

        # Check backend with retry
        echo "üîç Checking backend service..."
        for i in {1..5}; do
          if ssh -o ConnectTimeout=30 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'curl -f http://localhost:3001/health > /dev/null 2>&1'; then
            echo "‚úÖ Backend is running and healthy"
            break
          else
            echo "‚è≥ Backend check attempt $i/5 failed, waiting..."
            sleep 10
          fi
        done

        # Check PM2 status
        echo "üîç Checking PM2 processes..."
        ssh -o ConnectTimeout=30 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'pm2 list | grep pinovara || echo "‚ö†Ô∏è PM2 process not found"'

        # Check frontend
        echo "üîç Checking frontend service..."
        if ssh -o ConnectTimeout=30 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'curl -f http://localhost/ > /dev/null 2>&1'; then
          echo "‚úÖ Frontend is running"
        else
          echo "‚ö†Ô∏è Frontend may need Nginx configuration"
          # Show basic diagnostics
          ssh -o ConnectTimeout=30 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'ls -la /var/www/html/ | head -5 || echo "Frontend directory not found"'
        fi

        echo "üéâ Deployment verification complete!"
