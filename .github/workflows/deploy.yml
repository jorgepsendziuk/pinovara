name: Deploy to Production

# Workflow para deploy automático do PINOVARA
# Pré-requisitos na VM:
# - Node.js 18+
# - PM2 instalado globalmente
# - PostgreSQL configurado
# - Nginx configurado (opcional)
# - Chaves SSH configuradas
#
# Secrets necessárias no GitHub:
# - SSH_PRIVATE_KEY: Chave privada SSH
# - SERVER_HOST: pinovaraufba.com.br
# - SERVER_USER: Usuário SSH (ubuntu, etc.)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Validate Configuration
      run: |
        echo "🔧 Validating deployment configuration..."
        echo ""
        echo "📋 REQUIRED GitHub Secrets Configuration:"
        echo "=========================================="
        echo ""
        echo "Go to: Repository Settings → Secrets and variables → Actions"
        echo ""
        echo "Add these secrets:"
        echo ""
        echo "1. SSH_PRIVATE_KEY"
        echo "   How to get the value:"
        echo "   • Run: cat ~/.ssh/id_rsa"
        echo "   • Copy the ENTIRE output (including -----BEGIN OPENSSH PRIVATE KEY-----)"
        echo "   • Make sure to include all lines with proper line breaks"
        echo ""
        echo "2. SERVER_HOST"
        echo "   Value: pinovaraufba.com.br"
        echo ""
        echo "3. SERVER_USER"
        echo "   Value: ubuntu"
        echo "   (or your SSH username on the server)"
        echo ""
        echo "❌ Deployment will fail until these secrets are configured!"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Cache backend dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          ./backend/node_modules
        key: ${{ runner.os }}-backend-node-${{ hashFiles('backend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-backend-node-

    - name: Install backend dependencies
      working-directory: ./backend
      run: npm ci

    - name: Build backend
      working-directory: ./backend
      run: npm run build

    - name: Cache frontend dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          ./frontend/node_modules
        key: ${{ runner.os }}-frontend-node-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-node-

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Build frontend
      working-directory: ./frontend
      run: npm run build

    - name: Setup SSH
      run: |
        # Validate required secrets
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "❌ Error: SSH_PRIVATE_KEY secret is not configured"
          exit 1
        fi

        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "❌ Error: SERVER_HOST secret is not configured"
          exit 1
        fi

        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "❌ Error: SERVER_USER secret is not configured"
          exit 1
        fi

        echo "✅ All required secrets are configured"

        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        # Criar diretório temporário para arquivos
        DEPLOY_DIR="/tmp/pinovara-deploy-$(date +%s)"
        mkdir -p $DEPLOY_DIR

        # Copiar arquivos necessários
        echo "📦 Preparando arquivos para deploy..."
        echo "📁 Conteúdo do DEPLOY_DIR antes da cópia: $(ls -la $DEPLOY_DIR 2>/dev/null || echo 'DEPLOY_DIR vazio')"

        cp -r backend/package*.json backend/dist backend/prisma $DEPLOY_DIR/ 2>/dev/null || echo "⚠️ Alguns arquivos do backend podem não ter sido encontrados"
        cp -r frontend/dist $DEPLOY_DIR/frontend-dist 2>/dev/null || echo "⚠️ Arquivos do frontend podem não ter sido encontrados"

        echo "📁 Conteúdo do DEPLOY_DIR após cópia: $(ls -la $DEPLOY_DIR)"

        # Verificar se arquivo de configuração existe
        if [ -f "backend/config.env" ]; then
          cp backend/config.env $DEPLOY_DIR/
          echo "✅ config.env encontrado e copiado"
        else
          echo "⚠️ config.env não encontrado. Criando configuração básica..."
          echo 'NODE_ENV=production' > $DEPLOY_DIR/.env
          echo 'PORT=3001' >> $DEPLOY_DIR/.env
          echo 'DATABASE_URL="postgresql://user:password@localhost:5432/pinovara"' >> $DEPLOY_DIR/.env
          echo 'JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"' >> $DEPLOY_DIR/.env
          echo "✅ Arquivo .env criado"
        fi

        echo "📁 Arquivos finais no DEPLOY_DIR: $(ls -la $DEPLOY_DIR)"

        # Arquivo de configuração do PM2
        cat > $DEPLOY_DIR/ecosystem.config.js << 'EOF'
        module.exports = {
          apps: [{
            name: 'pinovara-backend',
            script: 'dist/server.js',
            cwd: '/var/www/pinovara/backend',
            instances: 1,
            exec_mode: 'fork',
            env: {
              NODE_ENV: 'production',
              PORT: 3001
            },
            env_production: {
              NODE_ENV: 'production',
              PORT: 3001
            }
          }]
        };
        EOF

        # Script de deploy
        cat > $DEPLOY_DIR/deploy.sh << 'EOF'
        #!/bin/bash
        # set -e  # Temporarily disabled for debugging

        echo "🚀 Iniciando deploy do PINOVARA..."

        # Navegar para o diretório dos arquivos de deploy
        cd /tmp || exit 1
        echo "📁 Diretório atual: $(pwd)"
        echo "📁 Arquivos disponíveis: $(ls -la)"
        echo "📁 Arquivos de deploy encontrados:"
        ls -la | grep -E "(deploy|package|dist|prisma|frontend|\.env)" || echo "⚠️ Alguns arquivos podem estar faltando"

        # Verificar se PM2 está instalado
        if ! command -v pm2 &> /dev/null; then
          echo "❌ PM2 não está instalado. Instale com: npm install -g pm2"
          exit 1
        fi

        echo "✅ PM2 está instalado"

        # Função para rollback em caso de erro
        rollback() {
          echo "❌ Erro durante o deploy. Executando rollback..."
          # Stop and delete PM2 process if it exists
          if pm2 list 2>/dev/null | grep -q pinovara-backend; then
            pm2 stop pinovara-backend 2>/dev/null || true
            pm2 delete pinovara-backend 2>/dev/null || true
          fi
          if [ -d "/var/www/pinovara/backup" ]; then
            rm -rf /var/www/pinovara/backend
            cp -r /var/www/pinovara/backup /var/www/pinovara/backend || true
            cd /var/www/pinovara/backend
            pm2 start ecosystem.config.js --env production 2>/dev/null || true
          fi
          exit 1
        }

        # trap rollback ERR  # Temporarily disabled for debugging
        echo "⚠️ Modo debug ativado - erros não interromperão o script automaticamente"

        # Criar diretórios
        sudo mkdir -p /var/www/pinovara
        sudo chown -R $USER:$USER /var/www/pinovara

        # Backup da versão anterior
        if [ -d "/var/www/pinovara/backend" ]; then
          echo "📦 Criando backup da versão anterior..."
          rm -rf /var/www/pinovara/backup
          cp -r /var/www/pinovara/backend /var/www/pinovara/backup
        fi

        # Deploy do backend
        echo "📦 Deploying backend..."
        if [ -d "/var/www/pinovara/backend" ]; then
          cd /var/www/pinovara/backend
          # Stop and delete PM2 process if it exists
          if pm2 list | grep -q pinovara-backend; then
            echo "🛑 Stopping existing PM2 process..."
            pm2 stop pinovara-backend 2>/dev/null || true
            pm2 delete pinovara-backend 2>/dev/null || true
          fi
        fi
 
        rm -rf /var/www/pinovara/backend
        mkdir -p /var/www/pinovara/backend

        # Copy deployment files to backend directory
        echo "📋 Copiando arquivos de deploy..."

        # Debug: Check what files exist
        echo "🔍 Verificando arquivos disponíveis para cópia:"
        [ -f "package.json" ] && echo "✅ package.json encontrado" || echo "❌ package.json não encontrado"
        [ -f "ecosystem.config.js" ] && echo "✅ ecosystem.config.js encontrado" || echo "❌ ecosystem.config.js não encontrado"
        [ -d "dist" ] && echo "✅ dist/ encontrado" || echo "❌ dist/ não encontrado"
        [ -d "prisma" ] && echo "✅ prisma/ encontrado" || echo "❌ prisma/ não encontrado"
        [ -f ".env" ] && echo "✅ .env encontrado" || echo "❌ .env não encontrado"

        # Copy files with detailed logging
        if [ -f "package.json" ]; then
          echo "📄 Copiando package.json..."
          cp package*.json /var/www/pinovara/backend/ && echo "✅ package.json copiado"
        fi

        if [ -f "ecosystem.config.js" ]; then
          echo "📄 Copiando ecosystem.config.js..."
          cp ecosystem.config.js /var/www/pinovara/backend/ && echo "✅ ecosystem.config.js copiado"
        fi

        if [ -d "dist" ]; then
          echo "📁 Copiando dist/..."
          cp -r dist /var/www/pinovara/backend/ && echo "✅ dist/ copiado"
        fi

        if [ -d "prisma" ]; then
          echo "📁 Copiando prisma/..."
          cp -r prisma /var/www/pinovara/backend/ && echo "✅ prisma/ copiado"
        fi

        if [ -f ".env" ]; then
          echo "📄 Copiando .env..."
          cp .env /var/www/pinovara/backend/ && echo "✅ .env copiado"
        fi

        cd /var/www/pinovara/backend
        echo "📁 Diretório final: $(pwd)"
        echo "📁 Arquivos no diretório backend: $(ls -la)"

        # Instalar dependências de produção
        echo "📦 Instalando dependências..."
        npm ci --production

        # Configurar banco de dados
        echo "🗄️ Configurando banco de dados..."
        npx prisma generate
        npx prisma db push --accept-data-loss || npx prisma db push

        # Iniciar aplicação com PM2
        echo "🚀 Iniciando aplicação..."
        echo "📁 Diretório atual: $(pwd)"
        echo "📁 Arquivos no diretório: $(ls -la)"

        # Ensure PM2 daemon is running
        pm2 ping 2>/dev/null || pm2 resurrect 2>/dev/null || true

        # Start the application
        if [ -f "ecosystem.config.js" ]; then
          echo "📄 Encontrado ecosystem.config.js"
          if pm2 start ecosystem.config.js --env production; then
            echo "✅ Aplicação iniciada com sucesso"
            pm2 save 2>/dev/null || true
            pm2 list
          else
            echo "❌ Falha ao iniciar aplicação com PM2"
            pm2 logs pinovara-backend --lines 10 2>/dev/null || echo "Não foi possível obter logs do PM2"
            exit 1
          fi
        else
          echo "❌ Arquivo ecosystem.config.js não encontrado!"
          ls -la
          exit 1
        fi

        # Aguardar aplicação iniciar
        echo "⏳ Aguardando aplicação iniciar..."
        sleep 10

        # Verificar se aplicação está funcionando
        if curl -f http://localhost:3001/health > /dev/null 2>&1; then
          echo "✅ Backend está funcionando!"
        else
          echo "❌ Backend não está respondendo. Verificando logs..."
          pm2 logs pinovara-backend --lines 20
          rollback
        fi

        # Deploy do frontend
        echo "🎨 Deploying frontend..."
        sudo mkdir -p /var/www/html
        sudo rm -rf /var/www/html/*

        # Copy frontend files from deployment directory
        if [ -d "/tmp/frontend-dist" ]; then
          echo "📋 Copiando arquivos do frontend..."
          sudo cp -r /tmp/frontend-dist/* /var/www/html/
          echo "✅ Frontend copiado com sucesso"
        else
          echo "⚠️ Diretório frontend-dist não encontrado em /tmp/"
          ls -la /tmp/ | grep frontend
        fi

        # Verificar se frontend está acessível
        if curl -f http://localhost/ > /dev/null 2>&1; then
          echo "✅ Frontend está funcionando!"
        else
          echo "⚠️ Aviso: Frontend pode não estar configurado corretamente"
        fi

        # Limpar backup após deploy bem-sucedido
        rm -rf /var/www/pinovara/backup

        echo ""
        echo "📊 RESUMO DO DEPLOY:"
        echo "===================="

        # Verificar status final
        if pm2 list 2>/dev/null | grep -q pinovara-backend; then
          echo "✅ PM2: Processo pinovara-backend está rodando"
          pm2 list | grep pinovara-backend || echo "⚠️ Detalhes do PM2 não disponíveis"
        else
          echo "❌ PM2: Processo pinovara-backend não encontrado"
        fi

        if [ -d "/var/www/pinovara/backend" ]; then
          echo "✅ Backend: Diretório existe"
          ls -la /var/www/pinovara/backend/ | wc -l | xargs echo "   Arquivos no backend:" || echo "   ⚠️ Não foi possível contar arquivos"
        else
          echo "❌ Backend: Diretório não existe"
        fi

        if [ -d "/var/www/html" ]; then
          echo "✅ Frontend: Diretório existe"
          ls -la /var/www/html/ | wc -l | xargs echo "   Arquivos no frontend:" || echo "   ⚠️ Não foi possível contar arquivos"
        else
          echo "❌ Frontend: Diretório não existe"
        fi

        echo ""
        echo "🌐 URLs esperadas:"
        echo "   Backend API: http://localhost:3001"
        echo "   Frontend: http://localhost/"
        echo "   Health Check: http://localhost:3001/health"

        echo ""
        echo "✅ Deploy concluído com sucesso!"
        echo "🌐 Aplicação disponível em: http://pinovaraufba.com.br"
        EOF

        chmod +x $DEPLOY_DIR/deploy.sh

        # Enviar arquivos para o servidor
        echo "📤 Enviando arquivos para o servidor..."
        scp -r $DEPLOY_DIR/* ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

        # Listar arquivos enviados para debug
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
          echo "📁 Todos os arquivos em /tmp/:"
          ls -la /tmp/
          echo ""
          echo "📁 Arquivos específicos do deploy:"
          ls -la /tmp/ | grep -E "(deploy|package|dist|prisma|frontend|\.env|\.js)" || echo "⚠️ Alguns arquivos podem não ter sido encontrados"
        '

        # Executar deploy no servidor
        echo "🚀 Executando script de deploy..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash /tmp/deploy.sh'

        # Limpar arquivos temporários
        rm -rf $DEPLOY_DIR
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'rm -rf /tmp/deploy.sh /tmp/ecosystem.config.js /tmp/package*.json /tmp/dist /tmp/frontend-dist /tmp/config.env /tmp/prisma'

    - name: Verify deployment
      run: |
        echo "🔍 Verificando deploy..."

        # Aguardar um pouco mais para garantir que tudo está funcionando
        sleep 15

        # Verificar status do PM2
        echo "📊 Verificando status do PM2..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'pm2 list'

        # Verificar se o backend está rodando
        echo "🔧 Verificando backend..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "if curl -f --max-time 10 http://localhost:3001/health; then echo '✅ Backend está funcionando!'; else echo '❌ Backend não está respondendo na porta 3001'; pm2 logs pinovara-backend --lines 10; exit 1; fi"

        # Verificar se o frontend está acessível
        echo "🎨 Verificando frontend..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "if curl -f --max-time 10 http://localhost/; then echo '✅ Frontend está funcionando!'; else echo '⚠️ Frontend pode não estar configurado (Nginx necessário)'; echo 'Verificando se os arquivos estão no lugar...'; ls -la /var/www/html/ | head -5; fi"

        echo "✅ Deploy verificado com sucesso!"
        echo "🌐 Aplicação disponível em: http://pinovaraufba.com.br"

    - name: Notify on success
      if: success()
      run: |
        echo "🎉 Deploy realizado com sucesso!"
        echo "📅 $(date)"
        echo "🔗 https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Deploy falhou!"
        echo "📅 $(date)"
        echo "🔗 https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "Verifique os logs para mais detalhes."

    - name: Cleanup
      if: always()
      run: |
        rm -rf ~/.ssh/id_rsa
