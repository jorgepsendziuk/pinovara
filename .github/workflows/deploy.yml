name: Deploy to Production

# Workflow para deploy autom√°tico do PINOVARA
# Pr√©-requisitos na VM:
# - Node.js 18+
# - PM2 instalado globalmente
# - PostgreSQL configurado
# - Nginx configurado (opcional)
# - Chaves SSH configuradas
#
# Secrets necess√°rias no GitHub:
# - SSH_PRIVATE_KEY: Chave privada SSH
# - SERVER_HOST: pinovaraufba.com.br
# - SERVER_USER: Usu√°rio SSH (ubuntu, etc.)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Cache backend dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          ./backend/node_modules
        key: ${{ runner.os }}-backend-node-${{ hashFiles('backend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-backend-node-

    - name: Install backend dependencies
      working-directory: ./backend
      run: npm ci

    - name: Build backend
      working-directory: ./backend
      run: npm run build

    - name: Cache frontend dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          ./frontend/node_modules
        key: ${{ runner.os }}-frontend-node-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-node-

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Build frontend
      working-directory: ./frontend
      run: npm run build

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        # Criar diret√≥rio tempor√°rio para arquivos
        DEPLOY_DIR="/tmp/pinovara-deploy-$(date +%s)"
        mkdir -p $DEPLOY_DIR

        # Copiar arquivos necess√°rios
        cp -r backend/package*.json backend/dist backend/prisma $DEPLOY_DIR/
        cp -r frontend/dist $DEPLOY_DIR/frontend-dist

        # Verificar se arquivo de configura√ß√£o existe
        if [ -f "backend/config.env" ]; then
          cp backend/config.env $DEPLOY_DIR/
        else
          echo "Aviso: config.env n√£o encontrado. Criando configura√ß√£o b√°sica..."
          cat > $DEPLOY_DIR/.env << 'EOF'
NODE_ENV=production
PORT=3001
DATABASE_URL="postgresql://user:password@localhost:5432/pinovara"
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
EOF
        fi

        # Arquivo de configura√ß√£o do PM2
        cat > $DEPLOY_DIR/ecosystem.config.js << 'EOF'
        module.exports = {
          apps: [{
            name: 'pinovara-backend',
            script: 'dist/server.js',
            cwd: '/var/www/pinovara/backend',
            instances: 1,
            exec_mode: 'fork',
            env: {
              NODE_ENV: 'production',
              PORT: 3001
            },
            env_production: {
              NODE_ENV: 'production',
              PORT: 3001
            }
          }]
        };
        EOF

        # Script de deploy
        cat > $DEPLOY_DIR/deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "üöÄ Iniciando deploy do PINOVARA..."

        # Fun√ß√£o para rollback em caso de erro
        rollback() {
          echo "‚ùå Erro durante o deploy. Executando rollback..."
          pm2 stop pinovara-backend || true
          pm2 delete pinovara-backend || true
          if [ -d "/var/www/pinovara/backup" ]; then
            cp -r /var/www/pinovara/backup/* /var/www/pinovara/backend/ || true
            pm2 start ecosystem.config.js --env production || true
          fi
          exit 1
        }

        trap rollback ERR

        # Criar diret√≥rios
        sudo mkdir -p /var/www/pinovara
        sudo chown -R $USER:$USER /var/www/pinovara

        # Backup da vers√£o anterior
        if [ -d "/var/www/pinovara/backend" ]; then
          echo "üì¶ Criando backup da vers√£o anterior..."
          rm -rf /var/www/pinovara/backup
          cp -r /var/www/pinovara/backend /var/www/pinovara/backup
        fi

        # Deploy do backend
        echo "üì¶ Deploying backend..."
        if [ -d "/var/www/pinovara/backend" ]; then
          cd /var/www/pinovara/backend
          pm2 stop pinovara-backend || true
          pm2 delete pinovara-backend || true
        fi

        rm -rf /var/www/pinovara/backend
        mkdir -p /var/www/pinovara/backend

        cp -r * /var/www/pinovara/backend/
        cd /var/www/pinovara/backend

        # Instalar depend√™ncias de produ√ß√£o
        echo "üì¶ Instalando depend√™ncias..."
        npm ci --production

        # Configurar banco de dados
        echo "üóÑÔ∏è Configurando banco de dados..."
        npx prisma generate
        npx prisma db push --accept-data-loss || npx prisma db push

        # Iniciar aplica√ß√£o com PM2
        echo "üöÄ Iniciando aplica√ß√£o..."
        pm2 start ecosystem.config.js --env production
        pm2 save

        # Aguardar aplica√ß√£o iniciar
        echo "‚è≥ Aguardando aplica√ß√£o iniciar..."
        sleep 10

        # Verificar se aplica√ß√£o est√° funcionando
        if curl -f http://localhost:3001/health > /dev/null 2>&1; then
          echo "‚úÖ Backend est√° funcionando!"
        else
          echo "‚ùå Backend n√£o est√° respondendo. Verificando logs..."
          pm2 logs pinovara-backend --lines 20
          rollback
        fi

        # Deploy do frontend
        echo "üé® Deploying frontend..."
        sudo mkdir -p /var/www/html
        sudo rm -rf /var/www/html/*
        sudo cp -r ../frontend-dist/* /var/www/html/

        # Verificar se frontend est√° acess√≠vel
        if curl -f http://localhost/ > /dev/null 2>&1; then
          echo "‚úÖ Frontend est√° funcionando!"
        else
          echo "‚ö†Ô∏è Aviso: Frontend pode n√£o estar configurado corretamente"
        fi

        # Limpar backup ap√≥s deploy bem-sucedido
        rm -rf /var/www/pinovara/backup

        echo "‚úÖ Deploy conclu√≠do com sucesso!"
        echo "üåê Aplica√ß√£o dispon√≠vel em: http://pinovaraufba.com.br"
        EOF

        chmod +x $DEPLOY_DIR/deploy.sh

        # Enviar arquivos para o servidor
        scp -r $DEPLOY_DIR/* ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

        # Executar deploy no servidor
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash /tmp/deploy.sh'

        # Limpar arquivos tempor√°rios
        rm -rf $DEPLOY_DIR
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'rm -rf /tmp/deploy.sh /tmp/ecosystem.config.js /tmp/package*.json /tmp/dist /tmp/frontend-dist /tmp/config.env /tmp/prisma'

    - name: Verify deployment
      run: |
        echo "üîç Verificando deploy..."

        # Aguardar um pouco mais para garantir que tudo est√° funcionando
        sleep 15

        # Verificar status do PM2
        echo "üìä Verificando status do PM2..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'pm2 list'

        # Verificar se o backend est√° rodando
        echo "üîß Verificando backend..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
          if curl -f --max-time 10 http://localhost:3001/health; then
            echo "‚úÖ Backend est√° funcionando!"
          else
            echo "‚ùå Backend n√£o est√° respondendo na porta 3001"
            pm2 logs pinovara-backend --lines 10
            exit 1
          fi
        '

        # Verificar se o frontend est√° acess√≠vel
        echo "üé® Verificando frontend..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
          if curl -f --max-time 10 http://localhost/; then
            echo "‚úÖ Frontend est√° funcionando!"
          else
            echo "‚ö†Ô∏è Frontend pode n√£o estar configurado (Nginx necess√°rio)"
            echo "Verificando se os arquivos est√£o no lugar..."
            ls -la /var/www/html/ | head -5
          fi
        '

        echo "‚úÖ Deploy verificado com sucesso!"
        echo "üåê Aplica√ß√£o dispon√≠vel em: http://pinovaraufba.com.br"

    - name: Notify on success
      if: success()
      run: |
        echo "üéâ Deploy realizado com sucesso!"
        echo "üìÖ $(date)"
        echo "üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Deploy falhou!"
        echo "üìÖ $(date)"
        echo "üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "Verifique os logs para mais detalhes."

    - name: Cleanup
      if: always()
      run: |
        rm -rf ~/.ssh/id_rsa
