name: Deploy Full (with Prisma)

# üöÄ PINOVARA Deploy FULL - WITH PRISMA CLIENT FROM DOCKER
# ‚ö° PRISMA GENERATED IN DOCKER - No server-side generation (fast & reliable)
# üìã BACKUP SYSTEM - Timestamp-based backups
# üîß MANUAL ONLY - Use when Prisma schema changed

on:
  workflow_dispatch:
    inputs:
      confirm_regeneration:
        description: 'Confirm Prisma regeneration (type "yes")'
        required: true
        default: 'no'

jobs:
  deploy-full:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_regeneration == 'yes'

    steps:
    - name: üöÄ Starting FULL Deploy with Prisma
      run: |
        echo "üéØ PINOVARA Deploy FULL - COMPLETE REGENERATION"
        echo "‚ö° REGENERATES Prisma client - For schema changes"
        echo "‚è±Ô∏è Expected time: ~8 minutes (includes Prisma generation)"
        echo "üìÖ $(date)"

    - name: üîß Validate Secrets
      run: |
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "‚ùå SSH_PRIVATE_KEY secret not configured"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "‚ùå SERVER_HOST secret not configured"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "‚ùå SERVER_USER secret not configured"
          exit 1
        fi
        echo "‚úÖ All secrets configured"

    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: üèóÔ∏è Build Backend
      working-directory: ./backend
      run: |
        echo "üî® Building backend..."
        npm ci
        npm run build
        echo "‚úÖ Backend built successfully"

    - name: üê≥ Build Docker Image & Extract Prisma Client
      working-directory: ./backend
      run: |
        echo "üê≥ Building Docker image to generate Prisma Client..."
        echo "‚ö° This replaces server-side prisma generate (faster & more reliable)"
        
        # Build Docker image (multi-stage, para at√© o stage builder)
        docker build --target builder -t pinovara-backend:builder .
        
        echo "üì¶ Extracting Prisma Client from Docker image..."
        
        # Criar container tempor√°rio para extrair Prisma Client
        CONTAINER_ID=$(docker create pinovara-backend:builder)
        
        # Criar diret√≥rio para Prisma Client
        mkdir -p ../prisma-client
        
        # Extrair Prisma Client do container
        # Copiar toda a estrutura @prisma
        echo "üì¶ Extracting @prisma directory..."
        docker cp $CONTAINER_ID:/app/node_modules/@prisma ../prisma-client/@prisma || {
          echo "‚ö†Ô∏è Failed to extract @prisma, trying alternative..."
          # Tentar extrair apenas o client se a estrutura for diferente
          docker cp $CONTAINER_ID:/app/node_modules/@prisma/client ../prisma-client/@prisma-client 2>/dev/null || {
            echo "‚ùå Failed to extract Prisma Client"
            docker rm $CONTAINER_ID
            exit 1
          }
        }
        
        # Extrair cache .prisma se existir (opcional)
        echo "üì¶ Extracting .prisma cache (optional)..."
        docker cp $CONTAINER_ID:/app/node_modules/.prisma ../prisma-client/.prisma 2>/dev/null || echo "‚ÑπÔ∏è .prisma cache not found (this is optional)"
        
        # Remover container tempor√°rio
        docker rm $CONTAINER_ID
        
        echo "‚úÖ Prisma Client extracted successfully from Docker image"
        echo "üìÅ Prisma Client location: ../prisma-client/"
        ls -la ../prisma-client/ | head -10

    - name: üé® Build Frontend
      working-directory: ./frontend
      run: |
        echo "üé® Building frontend..."
        npm ci
        echo "üìù Generating version info..."
        node scripts/generate-version.cjs
        npm run build
        echo "‚úÖ Frontend built successfully"

    - name: üîê Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: üöÄ Deploy to Server (FULL)
      run: |
        echo "üöÄ Starting FULL deployment to ${{ secrets.SERVER_HOST }}..."

        # Create temp directory
        DEPLOY_DIR="/tmp/pinovara-deploy-full-$(date +%s)"
        mkdir -p $DEPLOY_DIR

        # Copy files
        echo "üìã Preparing deployment files (FULL mode)..."
        
        # Copy backend files explicitly (no glob patterns!)
        cp backend/package.json $DEPLOY_DIR/package.json
        cp backend/package-lock.json $DEPLOY_DIR/package-lock.json
        cp -r backend/dist $DEPLOY_DIR/dist
        cp -r backend/prisma $DEPLOY_DIR/prisma
        
        # Copy Prisma Client generated from Docker image
        if [ -d "prisma-client" ]; then
          cp -r prisma-client $DEPLOY_DIR/prisma-client
          echo "‚úÖ Prisma Client from Docker image copied"
        else
          echo "‚ö†Ô∏è Prisma Client not found (will use existing on server or fail)"
        fi
        
        # Copy frontend
        cp -r frontend/dist $DEPLOY_DIR/frontend-dist
        
        echo "üì¶ Files copied: package.json, package-lock.json, dist/, prisma/"
        echo "‚ö° node_modules will be installed on server"

        # Create env file if config.env exists
        if [ -f "backend/config.env" ]; then
          cp backend/config.env $DEPLOY_DIR/.env
        else
          echo 'NODE_ENV=production' > $DEPLOY_DIR/.env
          echo 'PORT=3001' >> $DEPLOY_DIR/.env
          echo 'DATABASE_URL="postgresql://pinovara:pinovara@bd.pinovaraufba.com.br:5432/pinovara?schema=pinovara"' >> $DEPLOY_DIR/.env
          echo 'JWT_SECRET="pinovara-secret-key-change-in-production"' >> $DEPLOY_DIR/.env
        fi

        # Create PM2 config
        cat > $DEPLOY_DIR/ecosystem.config.js << 'EOF'
        module.exports = {
          apps: [{
            name: 'pinovara-backend',
            script: 'dist/server.js',
            cwd: '/var/www/pinovara/backend',
            instances: 1,
            exec_mode: 'fork',
            env: {
              NODE_ENV: 'production',
              PORT: 3001
            }
          }]
        };
        EOF

        # Create FULL deploy script
        cat > $DEPLOY_DIR/deploy-full.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "üöÄ PINOVARA v4.2 - FULL DEPLOY WITH PRISMA REGENERATION..."
        echo "‚ö° REGENERATING Prisma client (expected ~8 minutes)"
        echo "üìã BACKUP system enabled - Creating timestamped backups"

        # Check PM2
        if ! command -v pm2 &> /dev/null; then
          echo "‚ùå PM2 not installed"
          exit 1
        fi
        echo "‚úÖ PM2 available"

        # Backup System - Create timestamped backups before deployment
        BACKUP_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BACKUP_DIR="/var/www/pinovara/backup"
        
        echo "üíæ CREATING BACKUPS - Timestamp: $BACKUP_TIMESTAMP"
        
        # Create backup directory structure
        sudo mkdir -p "$BACKUP_DIR"
        sudo chown -R $USER:$USER "$BACKUP_DIR"
        
        # Backup existing backend if it exists
        if [ -d "/var/www/pinovara/backend" ]; then
          echo "üíæ Backing up existing backend..."
          mv /var/www/pinovara/backend "$BACKUP_DIR/backend-$BACKUP_TIMESTAMP"
          echo "‚úÖ Backend backed up to: $BACKUP_DIR/backend-$BACKUP_TIMESTAMP"
        else
          echo "‚ÑπÔ∏è No existing backend to backup"
        fi
        
        # Backup existing frontend if it exists
        if [ -d "/var/www/html" ] && [ "$(ls -A /var/www/html 2>/dev/null)" ]; then
          echo "üíæ Backing up existing frontend..."
          sudo mkdir -p "$BACKUP_DIR/frontend-$BACKUP_TIMESTAMP"
          sudo chown -R $USER:$USER "$BACKUP_DIR/frontend-$BACKUP_TIMESTAMP"
          cp -r /var/www/html/* "$BACKUP_DIR/frontend-$BACKUP_TIMESTAMP/" 2>/dev/null || true
          echo "‚úÖ Frontend backed up to: $BACKUP_DIR/frontend-$BACKUP_TIMESTAMP"
        else
          echo "‚ÑπÔ∏è No existing frontend to backup"
        fi
        
        # Cleanup old backups - keep only last 3 backups of each type
        echo "üßπ Cleaning up old backups (keeping last 3)..."
        
        # Clean backend backups
        cd "$BACKUP_DIR" && ls -d backend-* 2>/dev/null | head -n -3 | xargs rm -rf 2>/dev/null || true
        
        # Clean frontend backups
        cd "$BACKUP_DIR" && ls -d frontend-* 2>/dev/null | head -n -3 | xargs rm -rf 2>/dev/null || true
        
        echo "‚úÖ Backup system completed"

        # Create directories with proper ownership from start
        echo "üë§ Current user: $(whoami)"
        echo "üë§ \$USER variable: $USER"
        sudo mkdir -p /var/www/pinovara
        sudo chown -R $USER:$USER /var/www/pinovara

        # Stop existing processes
        pm2 stop pinovara-backend 2>/dev/null || true
        pm2 delete pinovara-backend 2>/dev/null || true

        # Create fresh backend directory (old one already backed up)
        mkdir -p /var/www/pinovara/backend

        # Copy files with explicit paths
        echo "üìã Deploying backend files..."
        DEPLOY_SOURCE="$DEPLOY_TMP_DIR"
        echo "üìÇ Source directory: $DEPLOY_SOURCE"
        echo "üìÇ Target directory: /var/www/pinovara/backend"

        # Navigate to source directory for copying
        cd "$DEPLOY_SOURCE" || { echo "‚ùå Failed to cd to $DEPLOY_SOURCE"; exit 1; }

        # Copy files with full paths (no sudo needed now)
        if [ -f "package.json" ]; then
            cp package.json /var/www/pinovara/backend/package.json
            echo "‚úÖ package.json copied"
        else
            echo "‚ùå package.json not found in $DEPLOY_SOURCE"
            exit 1
        fi
        
        if [ -f "package-lock.json" ]; then
            cp package-lock.json /var/www/pinovara/backend/package-lock.json
            echo "‚úÖ package-lock.json copied"
        else
            echo "‚ùå package-lock.json not found in $DEPLOY_SOURCE"
            ls -la "$DEPLOY_SOURCE"
            exit 1
        fi

        if [ -f ".env" ]; then
            cp .env /var/www/pinovara/backend/
            echo "‚úÖ .env copied"
        else
            echo "‚ùå .env not found in $DEPLOY_SOURCE"
        fi

        if [ -f "ecosystem.config.js" ]; then
            cp ecosystem.config.js /var/www/pinovara/backend/
            echo "‚úÖ ecosystem.config.js copied"
        else
            echo "‚ùå ecosystem.config.js not found in $DEPLOY_SOURCE"
            ls -la "$DEPLOY_SOURCE"/
        fi

        if [ -d "dist" ]; then
            cp -r dist /var/www/pinovara/backend/
            echo "‚úÖ dist/ copied"
        else
            echo "‚ùå dist/ not found in $DEPLOY_SOURCE"
        fi

        if [ -d "prisma" ]; then
            cp -r prisma /var/www/pinovara/backend/
            echo "‚úÖ prisma/ copied"
        else
            echo "‚ùå prisma/ not found in $DEPLOY_SOURCE"
        fi

        # Navigate to target directory for execution
        cd /var/www/pinovara/backend || { echo "‚ùå Failed to cd to /var/www/pinovara/backend"; exit 1; }
        echo "üìÇ Current directory: $(pwd)"
        echo "üìÅ Directory contents: $(ls -la)"

        # Ensure we're in the correct directory and it has the right files
        if [ ! -f "package.json" ]; then
          echo "‚ùå package.json not found in current directory"
          echo "üìÇ Current dir: $(pwd)"
          echo "üìÅ Contents: $(ls -la)"
          exit 1
        fi
        
        sudo chmod -R 777 /var/www/pinovara/backend 

        # Install dependencies on server (now with independent lockfiles!)
        echo "üì¶ Installing backend dependencies on server..."
        cd /var/www/pinovara/backend && npm ci --production --omit=dev
        echo "‚úÖ Dependencies installed successfully"

        # PRISMA CLIENT FROM DOCKER IMAGE (No server-side generation!)
        echo "üóÑÔ∏è Using Prisma Client from Docker image (pre-generated in CI)..."
        echo "‚ö° FAST MODE - No server-side generation needed!"
        
        # Check if Prisma Client was provided from CI
        if [ -d "$DEPLOY_SOURCE/prisma-client" ]; then
          echo "‚ö° Restoring Prisma Client from Docker image..."
          sudo mkdir -p /var/www/pinovara/backend/node_modules/@prisma
          sudo mkdir -p /var/www/pinovara/backend/node_modules/.prisma
          sudo chown -R $USER:$USER /var/www/pinovara/backend/node_modules/@prisma
          sudo chown -R $USER:$USER /var/www/pinovara/backend/node_modules/.prisma
          
          # Copiar Prisma Client
          if [ -d "$DEPLOY_SOURCE/prisma-client/@prisma" ]; then
            # Estrutura completa @prisma
            cp -r "$DEPLOY_SOURCE/prisma-client/@prisma" /var/www/pinovara/backend/node_modules/
          elif [ -d "$DEPLOY_SOURCE/prisma-client/@prisma-client" ]; then
            # Estrutura alternativa (apenas client)
            mkdir -p /var/www/pinovara/backend/node_modules/@prisma
            cp -r "$DEPLOY_SOURCE/prisma-client/@prisma-client" /var/www/pinovara/backend/node_modules/@prisma/client
          fi
          
          # Copiar cache .prisma se existir
          if [ -d "$DEPLOY_SOURCE/prisma-client/.prisma" ]; then
            cp -r "$DEPLOY_SOURCE/prisma-client/.prisma" /var/www/pinovara/backend/node_modules/ 2>/dev/null || true
          fi
          
          echo "‚úÖ Prisma Client restored from Docker image (FAST!)"
        else
          echo "‚ö†Ô∏è Prisma Client not found in deploy package"
          echo "üîÑ Falling back to existing client on server..."
          if [ ! -d "/var/www/pinovara/backend/node_modules/@prisma/client" ]; then
            echo "‚ùå No Prisma Client available - deployment may fail"
            echo "üí° Try running regular deploy first to establish client"
          fi
        fi
        
        # NOTE: Database schema is NEVER modified by deploy
        # System adapts to existing database structure

        # Start application
        echo "üöÄ Starting application..."
        echo "üìÇ Current directory: $(pwd)"
        echo "üìÑ Files in directory: $(ls -la)"

        if [ -f "ecosystem.config.js" ]; then
            echo "‚úÖ ecosystem.config.js found, starting PM2..."
            pm2 start ecosystem.config.js --env production
            pm2 save
            echo "‚úÖ Application started successfully"
        else
            echo "‚ùå ecosystem.config.js not found in $(pwd)"
            echo "üìÑ Available files:"
            ls -la
            exit 1
        fi

        # Deploy frontend
        echo "üé® Deploying frontend..."
        sudo mkdir -p /var/www/html
        sudo chown -R $USER:$USER /var/www/html
        # Frontend backup already done above, now clean and deploy fresh files
        rm -rf /var/www/html/* 2>/dev/null || true
        
        # Navigate to source directory for frontend deployment
        cd "$DEPLOY_TMP_DIR" || { echo "‚ùå Failed to cd to $DEPLOY_TMP_DIR"; exit 1; }
        
        if [ -d "frontend-dist" ]; then
          echo "üìÅ Found frontend-dist directory"
          ls -la frontend-dist/ | head -5
          cp -r frontend-dist/* /var/www/html/
          echo "‚úÖ Frontend deployed successfully"
          echo "üìä Files in /var/www/html:"
          ls -la /var/www/html/ | head -5
        else
          echo "‚ùå Frontend files not found"
          echo "üìÇ Available directories:"
          ls -la "$DEPLOY_TMP_DIR"
        fi

        echo "‚úÖ FULL DEPLOYMENT COMPLETED SUCCESSFULLY!"
        
        # Show backup status
        echo ""
        echo "üíæ BACKUP STATUS:"
        if [ -d "$BACKUP_DIR" ]; then
          echo "üìÅ Backup directory: $BACKUP_DIR"
          echo "üìä Available backups:"
          ls -la "$BACKUP_DIR" | grep -E "(backend-|frontend-)" | tail -10 || echo "   No backups found"
        else
          echo "‚ö†Ô∏è No backup directory found"
        fi
        EOF

        chmod +x $DEPLOY_DIR/deploy-full.sh

        # Upload and execute
        scp -r $DEPLOY_DIR ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        echo 'üë§ SSH User: ${{ secrets.SERVER_USER }}'
        echo 'üë§ Current user in SSH session: \$(whoami)'
        echo 'üë§ \$USER variable in SSH: '\$USER
        DEPLOY_TMP_DIR=\$(ls -d /tmp/pinovara-deploy-full-* | head -1)
        export DEPLOY_TMP_DIR
        bash \$DEPLOY_TMP_DIR/deploy-full.sh
        "

        # Cleanup
        rm -rf $DEPLOY_DIR
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'rm -rf /tmp/pinovara-deploy-full-*'

    - name: ‚úÖ Verify Deployment
      run: |
        echo "üîç Verifying FULL deployment..."
        sleep 10

        # Check backend
        if ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'curl -f http://localhost:3001/health > /dev/null 2>&1'; then
          echo "‚úÖ Backend is running"
        else
          echo "‚ùå Backend not responding"
        fi

        # Check frontend
        if ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'curl -f http://localhost/ > /dev/null 2>&1'; then
          echo "‚úÖ Frontend is running"
        else
          echo "‚ö†Ô∏è Frontend may need Nginx configuration"
        fi

        echo "üéâ FULL Deployment verification complete!"
